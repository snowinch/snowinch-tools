# ğŸš€ Release Process

This document explains how to release packages in the `snowinch-tools` monorepo.

## ğŸ¯ Overview

We use **Changesets** + **GitHub Actions** for automated releases:

1. Developers create changesets when making changes
2. GitHub Actions automatically creates a "Version Packages" PR
3. When merged, packages are automatically published to npm

---

## ğŸ“‹ Setup (One-Time)

### 1. Get npm Token

```bash
# Login to npm
npm login

# Generate automation token
npm token create --type automation
# Copy the token (starts with npm_...)
```

### 2. Add npm Token to GitHub

1. Go to: `https://github.com/your-org/snowinch-tools/settings/secrets/actions`
2. Click "New repository secret"
3. Name: `NPM_TOKEN`
4. Value: Paste your npm token
5. Click "Add secret"

### 3. Verify Workflows

Check that these files exist:

- `.github/workflows/release.yml` - Automated releases
- `.github/workflows/ci.yml` - Continuous integration

---

## ğŸ”„ Release Workflow

### Development Phase (on `main` branch)

```bash
# 1. Make changes to a package
vim packages/githubcron/src/ServerlessCron.ts

# 2. Commit (changeset auto-generated by pre-commit hook)
git add .
git commit -m "feat: add retry mechanism"
# â†’ Pre-commit hook creates changeset automatically
# â†’ You just choose type (patch/minor/major) and description

# 3. Push to main
git push origin main

# 4. Repeat for more features/fixes during the week
# All changesets accumulate on main
```

### Release Phase (when ready to publish)

```bash
# 1. Create PR: main â†’ production
# Go to GitHub and create PR from main to production
# Title: "Release v0.x.0" or similar

# 2. Merge the PR
# This triggers the automated release process
```

### Automated Release Process

When you merge `main` â†’ `production`:

1. **CI Workflow** runs:
   - âœ… Lints code
   - âœ… Type checks
   - âœ… Builds packages
   - âœ… Runs tests

2. **Release Workflow** runs:
   - ğŸ” Detects changesets in `.changeset/`
   - ğŸ“ Creates/updates PR "Version Packages"
3. **PR "Version Packages"** contains:
   - Updated `package.json` versions
   - Updated `CHANGELOG.md` files
   - All changesets consumed

4. **When you merge the PR**:
   - ğŸš€ Packages are automatically published to npm
   - ğŸ·ï¸ Git tags are created (e.g., `@snowinch/githubcron@0.2.0`)
   - ğŸ“ GitHub releases are created

5. **Automatic Backmerge**:
   - ğŸ”„ The `backmerge.yml` workflow automatically syncs `production` â†’ `main`
   - âœ… Ensures `main` has the updated package versions
   - âœ… Keeps both branches in sync

---

## ğŸŒ³ Branch Strategy

- **`main`**: Development branch (feature branches â†’ main)
  - Contains new features + changesets
  - Always ready for release
  - Protected: Requires CI to pass

- **`production`**: Release branch (main â†’ production)
  - Only updated via PR from main
  - Triggers automated releases
  - Protected: Requires PR + CI

**Flow**: `feature` â†’ `main` â†’ `production` â†’ npm â†’ backmerge to `main`

---

## ğŸ“¦ Manual Release (Optional)

If you prefer manual control:

```bash
# 1. Update versions and consume changesets
npm run version-packages

# 2. Review changes
git status
cat packages/githubcron/CHANGELOG.md

# 3. Commit version bump
git add .
git commit -m "chore: release packages"

# 4. Publish to npm
npm run release

# 5. Push changes and tags
git push --follow-tags
```

---

## ğŸ¯ Release Strategy

### Version Types

| Type      | When to Use                        | Version Bump  |
| --------- | ---------------------------------- | ------------- |
| **patch** | Bug fixes, typos, docs             | 0.1.0 â†’ 0.1.1 |
| **minor** | New features (backward compatible) | 0.1.0 â†’ 0.2.0 |
| **major** | Breaking changes                   | 0.1.0 â†’ 1.0.0 |

### Release Frequency

Choose what works best:

- **Weekly**: Good for active development
- **Bi-weekly**: Balanced approach
- **Monthly**: For stable packages
- **On-demand**: When features are ready

---

## ğŸ“Š Monitoring Releases

### Check Pending Changes

```bash
# See what will be released
npx changeset status

# Output:
# @snowinch/githubcron
#   Minor Changes:
#     - Add retry mechanism
#     - Add timeout support
```

### Check Published Versions

```bash
# Check npm
npm view @snowinch/githubcron version

# Check GitHub releases
# https://github.com/your-org/snowinch-tools/releases
```

---

## ğŸ” Security

### npm Token Security

- âœ… Use **automation tokens** (not personal tokens)
- âœ… Store in **GitHub Secrets** (never commit)
- âœ… Rotate tokens every 6-12 months
- âœ… Revoke immediately if compromised

### Package Access

Control who can publish:

```bash
# Add team members
npm owner add username @snowinch/githubcron

# List owners
npm owner ls @snowinch/githubcron
```

---

## ğŸ› Troubleshooting

### Release Failed

Check GitHub Actions logs:

1. Go to Actions tab
2. Click failed workflow
3. Review error messages

Common issues:

- âŒ `NPM_TOKEN` not set â†’ Add to GitHub Secrets
- âŒ Build failed â†’ Fix linting/type errors
- âŒ Package name taken â†’ Change in `package.json`
- âŒ No permission â†’ Run `npm owner add`

### Emergency Unpublish

```bash
# Unpublish specific version (within 72h)
npm unpublish @snowinch/githubcron@0.2.0

# Deprecate version (after 72h)
npm deprecate @snowinch/githubcron@0.2.0 "Security issue - use 0.2.1+"
```

---

## ğŸ“ Examples

### Example 1: Bug Fix Release

```bash
# Fix bug
vim packages/githubcron/src/security.ts
git commit -m "fix: secret validation"
# â†’ Choose: 1 (patch)
# â†’ Description: "Fix secret validation bug"

git push
# â†’ CI passes
# â†’ "Version Packages" PR created: 0.1.0 â†’ 0.1.1
# â†’ Merge PR
# â†’ Auto-published to npm âœ¨
```

### Example 2: Feature Release

```bash
# Add feature
vim packages/githubcron/src/retry.ts
git commit -m "feat: add retry mechanism"
# â†’ Choose: 2 (minor)
# â†’ Description: "Add automatic retry for failed jobs"

git push
# â†’ "Version Packages" PR updated: 0.1.0 â†’ 0.2.0
# â†’ Merge PR when ready
# â†’ Auto-published to npm âœ¨
```

### Example 3: Multiple Changes

```bash
# Change 1
git commit -m "feat: add timeout"
# â†’ Changeset 1 (minor)

# Change 2
git commit -m "fix: memory leak"
# â†’ Changeset 2 (patch)

# Change 3
git commit -m "docs: improve readme"
# â†’ Changeset 3 (patch)

git push
# â†’ All 3 changesets accumulated
# â†’ "Version Packages" PR: 0.1.0 â†’ 0.2.0 (minor wins)
# â†’ CHANGELOG includes all 3 changes
# â†’ Merge PR
# â†’ Auto-published with all changes âœ¨
```

---

## ğŸ“ Best Practices

### 1. Test Before Release

Always test locally before pushing:

```bash
npm run build
npm test
```

### 2. Review Version Packages PR

Before merging:

- âœ… Check CHANGELOG.md is accurate
- âœ… Verify version bump is correct
- âœ… Ensure all changesets are consumed

### 3. Monitor After Release

After merging:

- âœ… Check npm: `npm view @snowinch/githubcron`
- âœ… Check GitHub releases
- âœ… Test installation: `npm install @snowinch/githubcron@latest`

### 4. Communicate Changes

- ğŸ“ Update main README if needed
- ğŸ“¢ Announce major releases
- ğŸ“– Write migration guides for breaking changes

---

## ğŸ”— Useful Links

- [Changesets Documentation](https://github.com/changesets/changesets)
- [npm Publishing Guide](https://docs.npmjs.com/packages-and-modules/contributing-packages-to-the-registry)
- [Semantic Versioning](https://semver.org/)
- [GitHub Actions Docs](https://docs.github.com/en/actions)

---

## ğŸ“ Support

Questions? Check:

1. This document
2. `AGENTS.md` for development guidelines
3. GitHub Issues
4. Team Slack channel

---

**Last Updated**: 2025-11-16
