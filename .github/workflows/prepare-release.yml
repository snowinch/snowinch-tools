name: Prepare Release

on:
  push:
    branches:
      - main
    paths:
      - '.changeset/*.md'
      - '!.changeset/README.md'

jobs:
  create-release-pr:
    name: Create Release PR to Production
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if PR already exists
        id: check_pr
        run: |
          PR_EXISTS=$(gh pr list --base production --head main --state open --json number --jq 'length')
          echo "exists=$PR_EXISTS" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.PAT }}

      - name: Create PR to production
        if: steps.check_pr.outputs.exists == '0'
        run: |
          gh pr create \
            --base production \
            --head main \
            --title "ðŸš€ Release: Sync main to production" \
            --body "This PR syncs changes from main to production to trigger the release process.

          ## What's Changed
          - Includes accumulated changesets from main
          - Ready for version bump and npm publish

          ## Process
          1. Review changes
          2. Merge this PR â†’ triggers release workflow on production
          3. Release workflow creates 'Version Packages' PR
          4. Merge 'Version Packages' PR â†’ publishes to npm
          5. Automatic backmerge to main

          **Auto-generated by prepare-release workflow**"
        env:
          GH_TOKEN: ${{ secrets.PAT }}

